YUI.add("moodle-gradereport_grader-gradereporttable",function(e,t){function i(){i.superclass.constructor.apply(this,arguments)}function u(){}function a(){}function f(){}var n={FOOTERROW:"#user-grades .avg",GRADECELL:"td.grade",GRADERTABLE:".gradeparent table",GRADEPARENT:".gradeparent",HEADERCELL:".gradebook-header-cell",STUDENTHEADER:"#studentheader",SPINNER:".gradebook-loading-screen",USERCELL:"#user-grades .user.cell"},r={OVERRIDDEN:"overridden",STICKYFOOTER:"gradebook-footer-row-sticky",TOOLTIPACTIVE:"tooltipactive"};e.extend(i,e.Base,{_eventHandles:[],graderTable:null,initializer:function(){this.graderRegion=e.one(n.GRADEPARENT),this.graderTable=e.one(n.GRADERTABLE),this.setupHighlighter(),this.setupFloatingHeaders(),this.setupTooltips(),this._hideSpinner()},showSpinner:function(){e.one(n.SPINNER).show()},hideSpinner:function(){e.one(n.SPINNER).hide()},getGradeUserName:function(e){var t=e.ancestor("tr"),n=t.one("th.user .username");return n?n.get("text"):""},getGradeItemName:function(t){var n=e.one("th.item[data-column='"+t.getData("column")+"']");return n?n.get("text"):""},getGradeFeedback:function(e){return e.getData("feedback")}}),e.namespace("M.gradereport_grader").ReportTable=i,e.namespace("M.gradereport_grader").init=function(t){return new e.M.gradereport_grader.ReportTable(t)};var s="vmarked",o="hmarked";u.ATTRS={},u.prototype={setupHighlighter:function(){this.graderRegion.delegate("click",this._highlightUser,"th.user, th.userreport, th.userfield, .gradebook-user-cell",this),this.graderRegion.delegate("click",this._highlightColumn,"th.item[data-column], .gradebook-header-cell",this)},_highlightColumn:function(t){var n=t.target.getData("column");if(typeof n=="undefined")return;e.all('td.cell[data-column="'+n+'"]').toggleClass(s)},_highlightUser:function(t){var n=t.target.ancestor("[data-uid]",!0),r;n&&(r=n.getData("uid"));if(typeof r=="undefined")return;e.all('td.cell[data-uid="'+r+'"]').toggleClass(o)}},e.Base.mix(e.M.gradereport_grader.ReportTable,[u]),a.ATTRS={},a.prototype={_cachedNode_firstUserCell:null,_cachedNode_firstHeaderCell:null,_cachedNode_lastUserCell:null,_cachedNode_navbar:null,_cachedNode_tableFooterRow:null,_menuNodes:{userColumn:null,userColumnHeader:null,assignmentHeaders:null,averageFooters:null},_firstUserCellTop:0,_firstUserCellLeft:0,_firstUserCellHeight:0,_firstUserCellWidth:0,_firstHeaderCellTop:0,_firstHeaderCellHeight:0,_lastUserCellTop:0,_userColumnWidth:211,_navbarOffset:0,_eventHandles:[],_handleResizeEvent:function(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame;if(typeof (window.requestAnimationFrame==="function")){var e=this;window.requestAnimationFrame(function(t){e._handleResizeEventInternal.call(e,t)})}else this._handleResizeEventInternal.call(this)},_handleResizeEventInternal:function(){this._handleTouchStartEvent(),this._calculateCellPositions(),this._handleScrollEventInternal();var t=this._menuNodes.assignmentHeaders.all(n.HEADERCELL),r=e.all("#user-grades .heading .cell"),i=this._cachedNode_firstHeaderCell.getX(),s=0;r.each(function(e,n){var r=t.item(n);s+=e.get("offsetWidth");var o={width:e.get("offsetWidth"),left:e.getX()-i+"px"};r.setStyles(o)});var o=e.all("#gradebook-footer-container .gradebook-footer-cell");if(o.size()!==0){var u=e.all("#user-grades .avg .cell");u.each(function(e,t){var n=o.item(t),r={width:e.get("offsetWidth"),left:e.getX()-i+"px"};n.setStyles(r)})}this._menuNodes.assignmentHeaders.setStyle("width",s)},_calculateCellPositions:function(){this._firstUserCellTop=this._cachedNode_firstUserCell.getY(),this._firstUserCellLeft=this._cachedNode_firstUserCell.getX(),this._firstUserCellHeight=this._cachedNode_firstUserCell.get("offsetHeight"),this._firstUserCellWidth=this._cachedNode_firstUserCell.get("offsetWidth"),this._firstHeaderCellTop=this._cachedNode_firstHeaderCell.getY(),this._firstHeaderCellHeight=this._cachedNode_firstHeaderCell.get("offsetHeight"),this._lastUserCellTop=this._cachedNode_lastUserCell.getY(),this._cachedNode_navbar?this._navbarOffset=this._cachedNode_navbar.get("offsetHeight"):this._navbarOffset=0},_handleScrollEvent:function(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame;if(typeof (window.requestAnimationFrame==="function")){var e=this;window.requestAnimationFrame(function(t){e._handleScrollEventInternal.call(e,t)})}else this._handleScrollEventInternal.call(this)},_handleScrollEventInternal:function(){var t={visibility:"visible"},n={visibility:"visible"},r={visibility:"visible"},i={visibility:"visible"},s={x:e.config.win.pageXOffset,y:e.config.win.pageYOffset},o={x:e.config.win.innerWidth,y:e.config.win.innerHeight},u=s.x>this._firstUserCellLeft;u?(i.left=s.x,r.left=s.x):(i.left=this._firstUserCellLeft,r.left=this._firstUserCellLeft,n.left=this._firstUserCellLeft);var a=this._firstHeaderCellTop<=s.y&&s.y<=this._lastUserCellTop;a?(r.top=this._firstUserCellTop+"px",i.top=s.y+this._navbarOffset+"px",t.top=s.y+this._navbarOffset+"px"):(r.top=this._firstUserCellTop+"px",i.top=this._firstHeaderCellTop+"px",t.top=this._firstHeaderCellTop+"px");var f=s.y+o.y-this._navbarOffset>this._firstUserCellTop+this._firstUserCellHeight&&s.y+o.y-this._navbarOffset<this._cachedNode_tableFooterRow.getY();f?n.top=s.y+o.y-this._navbarOffset+"px":n.top=this._cachedNode_tableFooterRow.getY(),this._menuNodes.userColumn.setStyles(r),this._menuNodes.userColumnHeader.setStyles(i),this._menuNodes.assignmentHeaders.setStyles(t),this._menuNodes.averageFooters.setStyles(n)},_TouchStarted:!1,_handleTouchStartEvent:function(){this._TouchStarted=!0;var e={visibility:"hidden"};this._menuNodes.userColumn.setStyles(e),this._menuNodes.userColumnHeader.setStyles(e),this._menuNodes.assignmentHeaders.setStyles(e),this._menuNodes.averageFooters.setStyles(e)},_setupEventHandlers:function(){this._eventHandles.push(e.one(e.
config.win).on("scroll",this._handleScrollEvent,this),e.one(e.config.win).on("resize",this._handleResizeEvent,this),e.one(e.config.win).on("orientationchange",this._handleResizeEvent,this),e.one(e.config.win).on("touchstart",this._handleTouchStartEvent,this))},_setupAbsUserColumn:function(){var t=e.all(n.USERCELL);this._menuNodes.userColumn=e.Node.create('<div aria-hidden="true" id="gradebook-user-container"></div>'),t.each(function(t){var n=e.Node.create('<div class="gradebook-user-cell"></div>');n.set("innerHTML",t.get("innerHTML")).setAttribute("data-uid",t.ancestor("tr").getData("uid")).setStyles({height:t.get("offsetHeight")+"px"}),this._menuNodes.userColumn.appendChild(n)},this),this._menuNodes.userColumn.setStyles({width:this._userColumnWidth+"px"}),this._menuNodes.userColumnHeader.insert(this._menuNodes.userColumn,"before")},_setupAbsUserColumnHeader:function(){var t=e.Node.create('<div aria-hidden="true" id="gradebook-user-header-container"></div>');t.set("innerHTML",this._cachedNode_firstHeaderCell.getHTML()),t.setStyles({height:this._firstHeaderCellHeight,width:this._firstUserCellWidth+"px"}),this.graderRegion.append(t),this._menuNodes.userColumnHeader=t},_setupAbsAssignmentFooters:function(){this._cachedNode_tableFooterRow=e.one("#user-grades .avg");if(!this._cachedNode_tableFooterRow)return;var t=this._cachedNode_tableFooterRow.all(".cell"),n=e.Node.create('<div aria-hidden="true" role="presentation" id="gradebook-footer-container"></div>'),r=0,i=this._cachedNode_tableFooterRow.getX();t.each(function(t){var s=e.Node.create('<div class="gradebook-footer-cell"></div>');s.set("innerHTML",t.getHTML()),s.setStyles({height:t.get("offsetHeight")+"px",left:t.getX()-i+"px",width:t.get("offsetWidth")+"px",top:"0px"}),n.append(s),r+=parseInt(t.get("offsetWidth"),10)},this);var s=e.one("#gradersubmit");if(s){var o=e.Node.create('<button class="btn btn-sm btn-default">'+s.getAttribute("value")+"</button>");o.on("click",function(){s.simulate("click")}),n.one(".gradebook-footer-cell").append(o)}n.setStyles({left:this._cachedNode_tableFooterRow.getX()+"px",bottom:0,height:"40px",width:r+"px"}),this.graderRegion.append(n),this._menuNodes.averageFooters=n},_setupAbsAssignmentHeaders:function(){var t=e.all("#user-grades tr.heading .cell");this._menuNodes.assignmentHeaders=e.Node.create('<div aria-hidden="true" id="gradebook-header-container"></div>');var n=0,r=0,i=this._cachedNode_firstHeaderCell.getX();t.each(function(t){var s=t.getX(),o=e.Node.create('<div class="gradebook-header-cell"></div>');o.append(t.getHTML()).addClass(t.getAttribute("class")).setData("column",t.getData("column")).setStyles({height:t.get("offsetHeight")+"px",display:"block",left:s-i+"px",position:"absolute",width:t.get("offsetWidth")+"px"}),n+=parseInt(t.get("offsetWidth"),10),r=t.get("offsetHeight"),this._menuNodes.assignmentHeaders.appendChild(o)},this),this._menuNodes.assignmentHeaders.setStyles({width:n+"px",height:r+"px"}),this._menuNodes.userColumnHeader.insert(this._menuNodes.assignmentHeaders,"before")},setupFloatingHeaders:function(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame;if(typeof (window.requestAnimationFrame==="function")){var e=this;e._setupFloatingHeadersInternal.call(this)}else _setupFloatingHeadersInternal()},_setupFloatingHeadersInternal:function(){this._cachedNode_firstUserCell=e.one(n.USERCELL),this._cachedNode_firstHeaderCell=e.one(n.STUDENTHEADER);var t=e.all(n.USERCELL);t.size()>1?this._cachedNode_lastUserCell=t.item(t.size()-2):this._cachedNode_lastUserCell=this._cachedNode_firstUserCell,this._cachedNode_navbar=e.one("header.navbar");if(!this._cachedNode_firstUserCell){this._hideSpinner();return}this._setupEventHandlers(),this._calculateCellPositions(),this._setupAbsUserColumnHeader(),this._setupAbsUserColumn(),this._setupAbsAssignmentHeaders(),this._setupAbsAssignmentFooters(),this._handleScrollEvent()},_showSpinner:function(){e.one(n.SPINNER).show()},_hideSpinner:function(){e.one(n.SPINNER).hide()}},e.Base.mix(e.M.gradereport_grader.ReportTable,[a]),f.ATTRS={},CONTENT='<div class="graderreportoverlay {{overridden}}" role="tooltip" aria-describedby="{{id}}"><div class="fullname">{{username}}</div><div class="itemname">{{itemname}}</div>{{#if feedback}}<div class="feedback">{{feedback}}</div>{{/if}}</div>',f.prototype={_tooltip:null,_tooltipHandler:null,_tooltipBoundingBox:null,tooltipTemplate:null,setupTooltips:function(){},_getTooltip:function(){return this._tooltip||(this._tooltip=new e.Overlay({visible:!1,render:e.one(n.GRADEPARENT)}),this._tooltipBoundingBox=this._tooltip.get("boundingBox"),this.tooltipTemplate=e.Handlebars.compile(CONTENT)),this._tooltip},_showTooltip:function(e){var t=e.currentTarget,n=this._getTooltip(),i=this;window.requestAnimationFrame(function(){n.set("bodyContent",i.tooltipTemplate({cellid:t.get("id"),username:i.getGradeUserName(t),itemname:i.getGradeItemName(t),feedback:i.getGradeFeedback(t),overridden:t.hasClass(r.OVERRIDDEN)?r.OVERRIDDEN:""})).set("xy",[t.getX()+t.get("offsetWidth")/2,t.getY()+t.get("offsetHeight")/2]).show(),e.currentTarget.addClass(r.TOOLTIPACTIVE)})},_hideTooltip:function(e){if(e.relatedTarget&&this._tooltipBoundingBox&&this._tooltipBoundingBox.contains(e.relatedTarget))return;if(this._tooltip){var t=this;window.requestAnimationFrame(function(){e.currentTarget.removeClass(r.TOOLTIPACTIVE),t._tooltip.hide()})}},_toggleTooltip:function(e){e.currentTarget.hasClass(r.TOOLTIPACTIVE)?this._hideTooltip(e):this._showTooltip(e)}},e.Base.mix(e.M.gradereport_grader.ReportTable,[f])},"@VERSION@",{requires:["base","node","event","handlebars","overlay","event-hover","node-event-simulate"]});
