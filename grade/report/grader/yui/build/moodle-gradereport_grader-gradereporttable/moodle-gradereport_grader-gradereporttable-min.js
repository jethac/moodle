YUI.add("moodle-gradereport_grader-gradereporttable",function(e,t){function i(){i.superclass.constructor.apply(this,arguments)}function f(){}var n={FOOTERROW:"#user-grades .avg",GRADECELL:"td.cell",HEADERCELL:".gradebook-header-cell",STUDENTHEADER:"#studentheader",SPINNER:".gradebook-loading-screen",USERCELL:"#user-grades .user.cell"},r={COLMARK:"vmarked",UIDMARK:"hmarked",STICKYFOOTER:"gradebook-footer-row-sticky"};e.extend(i,e.Base,{_eventHandles:[],initializer:function(){this.setupFloatingHeaders(),this._hideSpinner()},showSpinner:function(){e.one(n.SPINNER).show()},hideSpinner:function(){e.one(n.SPINNER).hide()},_highlightColumn:function(t){var n=t.target.getData("column");if(typeof n=="undefined")return;e.all('td.cell[data-column="'+n+'"]').toggleClass(r.COLMARK)},_highlightUser:function(t){var n=t.target.getData("uid");if(typeof n=="undefined")return;e.all('td.cell[data-uid="'+n+'"]').toggleClass(r.UIDMARK)}}),e.namespace("M.gradereport_grader").ReportTable=i,e.namespace("M.gradereport_grader").init=function(t){return new e.M.gradereport_grader.ReportTable(t)};var s="offsetWidth",o="offsetHeight",u="offsetLeft",a="offsetParent";f.ATTRS={},f.prototype={headerCell:null,firstUserCell:null,tableFooterRow:null,footerRow:null,assignmentHeadingContainer:null,userColumnHeader:null,userColumn:null,firstUserCellTop:0,firstUserCellLeft:0,lastUserCellTop:0,_eventHandles:[],initializer:function(){this.firstUserCell=e.one(n.USERCELL);if(!this.firstUserCell){this._hideSpinner();return}this._setupFloatingUserColumn(),this._setupFloatingUserHeader(),this._setupFloatingAssignmentHeaders(),this._setupFloatingAssignmentFooter(),this._calculateCellPositions(),this._handleScrollEvent(),this._setupEventHandlers(),this._hideSpinner()},_calculateCellPositions:function(){this.headerCellTop=this.headerCell.getY();var t=e.all(n.USERCELL);t.size()>1?(this.firstUserCellTop=t.item(1).getY(),this.firstUserCellLeft=t.item(0).getX(),this.lastUserCellTop=t.item(t.size()-2).getY()):(this.firstUserCell=0,this.lastUserCellTop=0),this.tableFooterRow&&(this.footerRowPosition=this.tableFooterRow.getY())},_setupEventHandlers:function(){this._eventHandles.push(e.one(e.config.win).on("scroll",this._handleScrollEvent,this),e.one(e.config.win).on("resize",this._handleResizeEvent,this),e.one(e.config.win).on("orientationchange",this._handleResizeEvent,this))},_showSpinner:function(){e.one(n.SPINNER).show()},_hideSpinner:function(){e.one(n.SPINNER).hide()},_setupFloatingUserColumn:function(){var t=e.all(n.USERCELL),r=e.Node.create('<div aria-hidden="true" id="gradebook-user-container"></div>');t.each(function(t){var n=e.Node.create('<div class="gradebook-user-cell"></div>');n.set("innerHTML",t.get("innerHTML")).setData("uid",t.getData("uid")).setStyles({height:t.get(o)+"px",width:t.get(s)+"px"}),r.appendChild(n)},this),r.delegate("click",this._highlightUser,"th.user, .gradebook-user-cell",this),r.setStyles({left:this.firstUserCell.getX()+"px",position:"absolute",top:this.firstUserCell.getY()+"px"}),e.one(e.config.doc.body).append(r),this.userColumn=r},_setupFloatingUserHeader:function(){this.headerCell=e.one(n.STUDENTHEADER);var t=e.Node.create('<div aria-hidden="true" id="gradebook-user-header-container"></div>');t.set("innerHTML",this.headerCell.getHTML()),t.setStyles({height:this.headerCell.get(o)+"px",left:this.firstUserCell.getX()+"px",position:"absolute",top:this.headerCell.getY()+"px",width:this.firstUserCell.get(s)+"px"}),e.one(e.config.doc.body).append(t),this.userColumnHeader=t},_setupFloatingAssignmentHeaders:function(){var t=e.all("#user-grades tr.heading .cell"),n=e.Node.create('<div aria-hidden="true" id="gradebook-header-container"></div>'),r=0,i=0,u=this.headerCell.getX();t.each(function(t){var a=t.getX(),f=e.Node.create('<div class="gradebook-header-cell"></div>');f.append(t.getHTML()).addClass(t.getAttribute("class")).setData("column",t.getData("column")).setStyles({height:t.get(o)+"px",left:a-u+"px",position:"absolute",width:t.get(s)+"px"}),r+=parseInt(t.get(s),10),i=t.get(o),n.appendChild(f)},this),n.delegate("click",this._highlightColumn,"th.item[data-column], .gradebook-header-cell",this),n.setStyles({height:i+"px",left:this.headerCell.getX()+"px",position:"absolute",top:this.headerCell.getY()+"px",width:r+"px"}),this.userColumnHeader.insert(n,"before"),this.assignmentHeadingContainer=n},_setupFloatingAssignmentFooter:function(){this.tableFooterRow=e.one("#user-grades .avg");if(!this.tableFooterRow)return;var t=this.tableFooterRow.all(".cell"),n=e.Node.create('<div aria-hidden="true" id="gradebook-footer-container"></div>'),r=0,i=this.tableFooterRow.getX();t.each(function(t){var u=e.Node.create('<div class="gradebook-footer-cell"></div>');u.set("innerHTML",t.getHTML()),u.setStyles({height:t.get(o)+"px",left:t.getX()-i+"px",position:"absolute",width:t.get(s)+"px"}),n.append(u),r+=parseInt(t.get(s),10)},this);var u=e.one("#gradersubmit");if(u){var a=e.Node.create('<button class="btn btn-sm btn-default">'+u.getAttribute("value")+"</button>");a.on("click",function(){YUI().use("node-event-simulate",function(e){e.one("#gradersubmit").simulate("click")})}),n.one(".gradebook-footer-cell").append(a)}n.setStyles({position:"absolute",left:this.tableFooterRow.getX()+"px",bottom:0,height:"40px",width:r+"px"}),e.one(e.config.doc.body).append(n),this.footerRow=n},_handleScrollEvent:function(){var t={},n={},i={},s={};t.left=this.headerCell.get(u)+this.headerCell.get(a).get(u)+"px",e.config.win.pageYOffset+40>this.headerCellTop?e.config.win.pageYOffset+40<this.lastUserCellTop?(t.top=e.config.win.pageYOffset+40+"px",n.top=e.config.win.pageYOffset+40+"px"):(t.top=this.lastUserCellTop+"px",n.top=this.lastUserCellTop+"px"):(t.top=this.headerCellTop+"px",n.top=this.headerCellTop+"px"),e.config.win.pageXOffset>this.firstUserCellLeft?(i.left=e.config.win.pageXOffset+"px",n.left=e.config.win.pageXOffset+"px"):(i.left=this.firstUserCellLeft+"px",n.left=this.firstUserCellLeft+"px"),this.footerRow&&(s.left=this.headerCell.get(u)+this.headerCell
.get(a).get(u)+"px",e.config.win.pageYOffset+e.config.win.innerHeight-40<this.footerRowPosition?(e.config.win.pageYOffset+e.config.win.innerHeight-40>this.firstUserCellTop?s.top=e.config.win.pageYOffset+e.config.win.innerHeight-40+"px":s.top=this.firstUserCellTop,this.footerRow.addClass(r.STICKYFOOTER)):(s.top=this.footerRowPosition+"px",this.footerRow.removeClass(r.STICKYFOOTER))),this.assignmentHeadingContainer.setStyles(t),this.userColumnHeader.setStyles(n),this.userColumn.setStyles(i),this.footerRow.setStyles(s)},_handleResizeEvent:function(){this._calculateCellPositions(),this._handleScrollEvent();var t=this.assignmentHeadingContainer.all(n.HEADERCELL),r=e.all("#user-grades .heading .cell"),i=this.headerCell.getX(),o=0;r.each(function(e,n){var r=t.item(n);o+=e.get(s);var u={width:e.get(s),left:e.getX()-i+"px"};r.setStyles(u)});var u=e.all("#gradebook-footer-container .gradebook-footer-cell");if(u.size()!==0){var a=e.all("#user-grades .avg .cell");a.each(function(e,t){var n=u.item(t),r={width:e.get(s),left:e.getX()-i+"px"};n.setStyles(r)})}this.assignmentHeadingContainer.setStyle("width",o)}},e.Base.mix(e.M.gradereport_grader.ReportTable,[f])},"@VERSION@",{requires:["base","node","event","node-event-simulate"]});
