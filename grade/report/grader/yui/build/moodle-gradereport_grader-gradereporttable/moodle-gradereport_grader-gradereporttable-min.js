YUI.add("moodle-gradereport_grader-gradereporttable",function(e,t){function i(){i.superclass.constructor.apply(this,arguments)}function u(){}function h(){}function p(){}var n={FOOTERROW:"#user-grades .avg",GRADECELL:"td.grade",GRADERTABLE:".gradeparent table",GRADEPARENT:".gradeparent",HEADERCELL:".gradebook-header-cell",STUDENTHEADER:"#studentheader",SPINNER:".gradebook-loading-screen",USERCELL:"#user-grades .user.cell"},r={OVERRIDDEN:"overridden",STICKYFOOTER:"gradebook-footer-row-sticky",TOOLTIPACTIVE:"tooltipactive"};e.extend(i,e.Base,{_eventHandles:[],graderTable:null,initializer:function(){this.graderRegion=e.one(n.GRADEPARENT),this.graderTable=e.one(n.GRADERTABLE),this.setupHighlighter(),this.setupFloatingHeaders(),this.setupTooltips(),this._hideSpinner()},showSpinner:function(){e.one(n.SPINNER).show()},hideSpinner:function(){e.one(n.SPINNER).hide()},getGradeUserName:function(e){var t=e.ancestor("tr"),n=t.one("th.user .username");return n?n.get("text"):""},getGradeItemName:function(t){var n=e.one("th.item[data-column='"+t.getData("column")+"']");return n?n.get("text"):""},getGradeFeedback:function(e){return e.getData("feedback")}}),e.namespace("M.gradereport_grader").ReportTable=i,e.namespace("M.gradereport_grader").init=function(t){return new e.M.gradereport_grader.ReportTable(t)};var s="vmarked",o="hmarked";u.ATTRS={},u.prototype={setupHighlighter:function(){this.graderRegion.delegate("click",this._highlightUser,"th.user, th.userreport, th.userfield, .gradebook-user-cell",this),this.graderRegion.delegate("click",this._highlightColumn,"th.item[data-column], .gradebook-header-cell",this)},_highlightColumn:function(t){var n=t.target.getData("column");if(typeof n=="undefined")return;e.all('td.cell[data-column="'+n+'"]').toggleClass(s)},_highlightUser:function(t){var n=t.target.ancestor("[data-uid]",!0),r;n&&(r=n.getData("uid"));if(typeof r=="undefined")return;e.all('td.cell[data-uid="'+r+'"]').toggleClass(o)}},e.Base.mix(e.M.gradereport_grader.ReportTable,[u]);var a="offsetWidth",f="offsetHeight",l="offsetLeft",c="offsetParent";h.ATTRS={},h.prototype={headerCell:null,firstUserCell:null,tableFooterRow:null,footerRow:null,assignmentHeadingContainer:null,userColumnHeader:null,userColumn:null,firstUserCellTop:0,firstUserCellHeight:0,firstUserCellLeft:0,lastUserCellTop:0,_eventHandles:[],setupFloatingHeaders:function(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame;if(typeof (window.requestAnimationFrame==="function")){var e=this;e._setupFloatingHeadersInternal.call(this)}else _setupFloatingHeadersInternal()},_setupFloatingHeadersInternal:function(){this.firstUserCell=e.one(n.USERCELL);if(!this.firstUserCell){this._hideSpinner();return}this._setupFloatingUserHeader(),this._setupFloatingAssignmentHeaders(),this._setupFloatingAssignmentFooter(),this._setupFloatingUserColumn(),this._calculateCellPositions(),this._handleScrollEvent(),this._setupEventHandlers(),this._hideSpinner()},_calculateCellPositions:function(){this.headerCellTop=this.headerCell.getY();var t=e.all(n.USERCELL);t.size()>1?(this.firstUserCellTop=t.item(1).getY(),this.firstUserCellLeft=t.item(0).getX(),this.lastUserCellTop=t.item(t.size()-2).getY()):(this.firstUserCell=0,this.lastUserCellTop=0,this.firstUserCellLeft=t.item(0).getX()),this.firstUserCellHeight=this.firstUserCell.get(f),this.tableFooterRow&&(this.footerRowPosition=this.tableFooterRow.getY())},_setupEventHandlers:function(){this._eventHandles.push(e.one(e.config.win).on("scroll",this._handleScrollEvent,this),e.one(e.config.win).on("resize",this._handleResizeEvent,this),e.one(e.config.win).on("orientationchange",this._handleResizeEvent,this))},_showSpinner:function(){e.one(n.SPINNER).show()},_hideSpinner:function(){e.one(n.SPINNER).hide()},_setupFloatingUserColumn:function(){var t=e.all(n.USERCELL),r=e.Node.create('<div aria-hidden="true" id="gradebook-user-container"></div>'),i=e.Node.create('<div aria-hidden="true" id="gradebook-user-container"></div>'),s=e.Node.create('<div id="gradebook-user-container-inner"></div>');t.each(function(t){var n=e.Node.create('<div class="gradebook-user-cell"></div>');n.set("innerHTML",t.get("innerHTML")).setAttribute("data-uid",t.ancestor("tr").getData("uid")).setStyles({height:t.get(f)+"px"}),s.appendChild(n)},this),r.setStyles({left:this.firstUserCell.getX()+"px",position:"absolute",top:this.firstUserCell.getY()+"px"});var o=e.one("header.navbar"),u=0;o&&(u=o.get("offsetHeight")),i.setStyles({position:"fixed",left:0,top:u+this.assignmentHeadingContainer.get("offsetHeight")-1,width:"211px",bottom:this.footerRow.get("offsetHeight")}),i.appendChild(s),this.userColumnHeader.insert(i,"before"),this.userColumn=r,this.userColumnInner=s,this.userColumnFixed=i},userColumnFixed:null,userColumnInner:null,_setupFloatingUserHeader:function(){this.headerCell=e.one(n.STUDENTHEADER);var t=e.Node.create('<div aria-hidden="true" id="gradebook-user-header-container"></div>');t.set("innerHTML",this.headerCell.getHTML()),t.setStyles({height:this.headerCell.get(f)+"px",width:this.firstUserCell.get(a)+"px"}),this.graderRegion.append(t),this.userColumnHeader=t},_setupFloatingAssignmentHeaders:function(){var t=e.all("#user-grades tr.heading .cell"),n=e.Node.create('<div aria-hidden="true" id="gradebook-header-container"></div>'),r=e.Node.create('<div id="gradebook-header-container-inner"></div>');n.appendChild(r);var i=0,s=0,o=this.headerCell.getX();t.each(function(t){var n=t.getX(),u=e.Node.create('<div class="gradebook-header-cell"></div>');u.append(t.getHTML()).addClass(t.getAttribute("class")).setData("column",t.getData("column")).setStyles({height:t.get(f)+"px",display:"block",left:n-o+"px",position:"absolute",width:t.get(a)+"px"}),i+=parseInt(t.get(a),10),s=t.get(f),r.appendChild(u)},this),this.userColumnHeader.insert(n,"before"),this.assignmentHeadingContainer=n,this.assignmentHeadingContainerInner=r},assignmentHeadingContainerInner:null
,_setupFloatingAssignmentFooter:function(){this.tableFooterRow=e.one("#user-grades .avg");if(!this.tableFooterRow)return;var t=this.tableFooterRow.all(".cell"),n=e.Node.create('<div aria-hidden="true" id="gradebook-footer-container"></div>'),r=e.Node.create('<div id="gradebook-footer-container-inner"></div>');n.appendChild(r);var i=0,s=this.tableFooterRow.getX();t.each(function(t){var n=e.Node.create('<div class="gradebook-footer-cell"></div>');n.set("innerHTML",t.getHTML()),n.setStyles({height:t.get(f)+"px",left:t.getX()-s+"px",width:t.get(a)+"px"}),r.append(n),i+=parseInt(t.get(a),10)},this);var o=e.one("#gradersubmit");if(o){var u=e.Node.create('<button class="btn btn-sm btn-default">'+o.getAttribute("value")+"</button>");u.on("click",function(){YUI().use("node-event-simulate",function(e){e.one("#gradersubmit").simulate("click")})}),r.one(".gradebook-footer-cell").append(u)}this.graderRegion.append(n),this.footerRow=r},_handleScrollEventInternal:function(t){var n={},r={},i={},s={},o={x:e.config.win.pageXOffset,y:e.config.win.pageYOffset},u=e.config.win.innerHeight,a=40,f=this.firstUserCellLeft-o.x+"px",l=o.y+a<=this.headerCellTop,c=o.y+a>this.headerCellTop,h=c&&o.y+a>=this.lastUserCellTop,p=!c||!h,d=o.y+u-a<this.footerRowPosition,v=o.y+u-a>this.firstUserCellTop,m=o.x>this.firstUserCellLeft;n.left=f,n.visibility=c&&!h?"visible":"hidden",s.visibility=c&&!h&&m||m?"visible":"hidden",s.left=m?"0px":f+"px",s.top=c&&!h?a+"px":this.firstUserCellTop-o.y-this.firstUserCellHeight-a+"px",r.left=f,r.visibility=d&&v?"visible":"hidden",i.visibility=m?"visible":"hidden",i.top=this.firstUserCellTop-o.y-80-this.firstUserCellHeight+"px",this.footerRow.setStyles(r),this.assignmentHeadingContainerInner.setStyles(n),this.userColumnInner.setStyles(i),this.userColumnHeader.setStyles(s)},_handleScrollEvent:function(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame;if(typeof (window.requestAnimationFrame==="function")){var e=this;window.requestAnimationFrame(function(t){e._handleScrollEventInternal.call(e,t)})}else this._handleScrollEventInternal.call(this)},_handleResizeEventInternal:function(t){this._calculateCellPositions(),this._handleScrollEventInternal();var r=this.assignmentHeadingContainer.all(n.HEADERCELL),i=e.all("#user-grades .heading .cell"),s=this.headerCell.getX(),o=0;i.each(function(e,t){var n=r.item(t);o+=e.get(a);var i={width:e.get(a),left:e.getX()-s+"px"};n.setStyles(i)});var u=e.all("#gradebook-footer-container .gradebook-footer-cell");if(u.size()!==0){var f=e.all("#user-grades .avg .cell");f.each(function(e,t){var n=u.item(t),r={width:e.get(a),left:e.getX()-s+"px"};n.setStyles(r)})}this.assignmentHeadingContainer.setStyle("width",o)},_handleResizeEvent:function(){window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame;if(typeof (window.requestAnimationFrame==="function")){var e=this;window.requestAnimationFrame(function(t){e._handleResizeEventInternal.call(e,t)})}else this._handleResizeEventInternal.call(this)}},e.Base.mix(e.M.gradereport_grader.ReportTable,[h]),p.ATTRS={},CONTENT='<div class="graderreportoverlay {{overridden}}" role="tooltip" aria-describedby="{{id}}"><div class="fullname">{{username}}</div><div class="itemname">{{itemname}}</div>{{#if feedback}}<div class="feedback">{{feedback}}</div>{{/if}}</div>',p.prototype={_tooltip:null,_tooltipHandler:null,_tooltipBoundingBox:null,tooltipTemplate:null,setupTooltips:function(){},_getTooltip:function(){return this._tooltip||(this._tooltip=new e.Overlay({visible:!1,render:e.one(n.GRADEPARENT)}),this._tooltipBoundingBox=this._tooltip.get("boundingBox"),this.tooltipTemplate=e.Handlebars.compile(CONTENT)),this._tooltip},_showTooltip:function(e){var t=e.currentTarget,n=this._getTooltip(),i=this,s=window.requestAnimationFrame(function(s){n.set("bodyContent",i.tooltipTemplate({cellid:t.get("id"),username:i.getGradeUserName(t),itemname:i.getGradeItemName(t),feedback:i.getGradeFeedback(t),overridden:t.hasClass(r.OVERRIDDEN)?r.OVERRIDDEN:""})).set("xy",[t.getX()+t.get("offsetWidth")/2,t.getY()+t.get("offsetHeight")/2]).show(),e.currentTarget.addClass(r.TOOLTIPACTIVE)})},_hideTooltip:function(e){if(e.relatedTarget&&this._tooltipBoundingBox&&this._tooltipBoundingBox.contains(e.relatedTarget))return;if(this._tooltip)var t=this,n=window.requestAnimationFrame(function(n){e.currentTarget.removeClass(r.TOOLTIPACTIVE),t._tooltip.hide()})},_toggleTooltip:function(e){e.currentTarget.hasClass(r.TOOLTIPACTIVE)?this._hideTooltip(e):this._showTooltip(e)}},e.Base.mix(e.M.gradereport_grader.ReportTable,[p])},"@VERSION@",{requires:["base","node","event","handlebars","overlay","event-hover","node-event-simulate"]});
